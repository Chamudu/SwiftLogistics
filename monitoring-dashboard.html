<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftLogistics Monitoring Console</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-green: #10b981;
            --accent-blue: #3b82f6;
            --accent-red: #ef4444;
            --accent-orange: #f59e0b;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #334155;
            padding-bottom: 20px;
            animation: fadeIn 0.8s;
        }

        h1 { margin: 0; font-weight: 300; letter-spacing: 1px; }
        .badge { 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 0.8em; 
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge.healthy { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); border: 1px solid var(--accent-green); }
        .badge.degraded { background: rgba(245, 158, 11, 0.2); color: var(--accent-orange); border: 1px solid var(--accent-orange); }
        .badge.down { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); border: 1px solid var(--accent-red); }

        /* GRID LAYOUT */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .metric-card:hover { transform: translateY(-3px); }

        .metric-title { font-size: 0.85em; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; }
        .metric-value { font-size: 2.2em; font-weight: 700; }
        .metric-sub { font-size: 0.9em; color: var(--text-secondary); margin-top: 5px; }

        .success-text { color: var(--accent-green); }
        .error-text { color: var(--accent-red); }

        /* PROTOCOL STATS */
        .protocol-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .proto-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .proto-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 4px; height: 100%;
        }

        .proto-rest::before { background: var(--accent-blue); }
        .proto-soap::before { background: var(--accent-orange); }
        .proto-tcp::before { background: var(--accent-green); }

        .proto-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .proto-name { font-weight: bold; font-size: 1.1em; }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; }
        .latency-bar { height: 4px; background: #334155; border-radius: 2px; margin-top: 10px; overflow: hidden; }
        .latency-fill { height: 100%; background: var(--accent-blue); width: 0%; transition: width 0.5s ease; }

        /* LOGGING CONSOLE */
        .console-container {
            background: #000;
            border: 1px solid #334155;
            border-radius: 8px;
            overflow: hidden;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .console-header {
            background: #1e293b;
            padding: 10px 15px;
            font-size: 0.9em;
            color: var(--text-secondary);
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
        }

        .console-body {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.85em;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #1e293b;
            display: flex;
            gap: 15px;
        }

        .log-time { color: #64748b; min-width: 80px; }
        .log-method { color: var(--accent-orange); min-width: 50px; }
        .log-path { color: var(--accent-blue); flex-grow: 1; }
        .log-status { font-weight: bold; min-width: 40px; text-align: right; }
        .log-duration { color: var(--text-secondary); min-width: 60px; text-align: right; }

        .status-200 { color: var(--accent-green); }
        .status-400, .status-404 { color: var(--accent-orange); }
        .status-500 { color: var(--accent-red); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>üì° API Gateway Monitor</h1>
            <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 5px;">
                System Time: <span id="sys-time">---</span> | Uptime: <span id="uptime">0s</span>
            </div>
        </div>
        <div class="badge checking" id="system-status">Checking Status...</div>
    </header>

    <!-- KPI Metrics -->
    <div class="dashboard-grid">
        <div class="metric-card">
            <div class="metric-title">Request Rate</div>
            <div class="metric-value" id="total-req">0</div>
            <div class="metric-sub">Total Hits</div>
        </div>
        <div class="metric-card">
            <div class="metric-title">Success Rate</div>
            <div class="metric-value success-text" id="success-rate">100%</div>
            <div class="metric-sub">Last 5 min</div>
        </div>
        <div class="metric-card">
            <div class="metric-title">Avg Latency</div>
            <div class="metric-value" id="global-latency">0ms</div>
            <div class="metric-sub">Processing Time</div>
        </div>
        <div class="metric-card">
            <div class="metric-title">Errors</div>
            <div class="metric-value error-text" id="error-count">0</div>
            <div class="metric-sub">Failures</div>
        </div>
    </div>

    <!-- Protocol Stats -->
    <div class="protocol-stats">
        <!-- REST -->
        <div class="proto-card proto-rest">
            <div class="proto-header">
                <span class="proto-name">REST Adapter</span>
                <span class="badge" style="border:1px solid #3b82f6; color:#3b82f6">HTTP</span>
            </div>
            <div class="stat-row">
                <span>Requests</span>
                <span id="rest-count">0</span>
            </div>
            <div class="stat-row">
                <span>Avg Response</span>
                <span id="rest-latency">0ms</span>
            </div>
            <div class="latency-bar">
                <div class="latency-fill" id="rest-bar" style="width: 0%"></div>
            </div>
        </div>

        <!-- SOAP -->
        <div class="proto-card proto-soap">
            <div class="proto-header">
                <span class="proto-name">SOAP Adapter</span>
                <span class="badge" style="color:var(--accent-orange); border:1px solid var(--accent-orange)">XML</span>
            </div>
            <div class="stat-row">
                <span>Requests</span>
                <span id="soap-count">0</span>
            </div>
            <div class="stat-row">
                <span>Avg Response</span>
                <span id="soap-latency">0ms</span>
            </div>
            <div class="latency-bar">
                <div class="latency-fill" id="soap-bar" style="width: 0%; background: var(--accent-orange)"></div>
            </div>
        </div>

        <!-- TCP -->
        <div class="proto-card proto-tcp">
            <div class="proto-header">
                <span class="proto-name">Warehouse (TCP)</span>
                <span class="badge" style="color:var(--accent-green); border:1px solid var(--accent-green)">Socket</span>
            </div>
            <div class="stat-row">
                <span>Requests</span>
                <span id="tcp-count">0</span>
            </div>
            <div class="stat-row">
                <span>Avg Response</span>
                <span id="tcp-latency">0ms</span>
            </div>
            <div class="latency-bar">
                <div class="latency-fill" id="tcp-bar" style="width: 0%; background: var(--accent-green)"></div>
            </div>
        </div>
    </div>

    <!-- Live Logs -->
    <div class="console-container">
        <div class="console-header">
            <span>LIVE REQUEST LOG</span>
            <span style="color: #10b981">‚óè Connected</span>
        </div>
        <div class="console-body" id="log-console">
            <!-- Logs injected here -->
            <div class="log-entry" style="justify-content:center; color:#64748b">Example Log Entry...</div>
        </div>
    </div>

</div>

<script>
    const API_URL = 'http://localhost:5000';

    async function fetchMetrics() {
        try {
            const res = await fetch(`${API_URL}/metrics`);
            const data = await res.json();
            updateDashboard(data);
            
            // Check health separately
            const healthRes = await fetch(`${API_URL}/health`);
            const healthData = await healthRes.json();
            updateHealthBadge(healthData.status);

        } catch (error) {
            console.error("Fetch error:", error);
            updateHealthBadge('down');
        }
    }

    function updateHealthBadge(status) {
        const badge = document.getElementById('system-status');
        badge.className = `badge ${status}`;
        badge.textContent = status === 'healthy' ? 'SYSTEM OPERATIONAL' : (status === 'down' ? 'SYSTEM OFFLINE' : 'DEGRADED');
    }

    function updateDashboard(data) {
        // System Info
        document.getElementById('sys-time').textContent = new Date().toLocaleTimeString();
        document.getElementById('uptime').textContent = formatUptime(data.uptime);

        // KPI
        document.getElementById('total-req').textContent = data.summary.total;
        document.getElementById('success-rate').textContent = `${data.summary.rate}%`;
        document.getElementById('error-count').textContent = data.summary.errors;
        
        // Calculate global avg latency
        const totalLat = data.latency.rest + data.latency.soap + data.latency.tcp;
        const activeProtos = [data.latency.rest, data.latency.soap, data.latency.tcp].filter(l => l > 0).length;
        document.getElementById('global-latency').textContent = activeProtos ? Math.round(totalLat / activeProtos) + 'ms' : '0ms';

        // Protocol Specifics
        updateProtoCard('rest', data.counts.rest, data.latency.rest);
        updateProtoCard('soap', data.counts.soap, data.latency.soap);
        updateProtoCard('tcp', data.counts.tcp, data.latency.tcp);

        // Logs
        renderLogs(data.log || []); // api-gateway sends 'logs' array but code implemented earlier sent 'recentLogs' in metrics object?
        // Wait, index.js sends 'logs: metrics.recentLogs'. Correct.
        renderLogs(data.logs);
    }

    function updateProtoCard(id, count, latency) {
        document.getElementById(`${id}-count`).textContent = count;
        document.getElementById(`${id}-latency`).textContent = `${latency}ms`;
        
        // Visual bar (cap at 200ms for full bar)
        const width = Math.min((latency / 200) * 100, 100);
        document.getElementById(`${id}-bar`).style.width = `${width}%`;
    }

    function renderLogs(logs) {
        const container = document.getElementById('log-console');
        if (!logs || logs.length === 0) return;

        container.innerHTML = logs.map(log => {
            const statusClass = log.status >= 500 ? 'status-500' : (log.status >= 400 ? 'status-400' : 'status-200');
            const time = new Date(log.timestamp).toLocaleTimeString();
            
            return `
                <div class="log-entry">
                    <span class="log-time">${time}</span>
                    <span class="log-method">${log.method}</span>
                    <span class="log-path">${log.path}</span>
                    <span class="log-status ${statusClass}">${log.status}</span>
                    <span class="log-duration">${log.duration}</span>
                </div>
            `;
        }).join('');
    }

    function formatUptime(seconds) {
        if (seconds < 60) return `${seconds}s`;
        const mins = Math.floor(seconds / 60);
        return `${mins}m ${seconds % 60}s`;
    }

    // Auto-refresh every 2 seconds
    setInterval(fetchMetrics, 2000);
    fetchMetrics(); // Initial call
</script>

</body>
</html>
